deploy_job:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -H 38.174.113.217 >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to server..."

    # 1) 生成一个脚本 kill_file_server.sh (在CI Runner本地)
    - |
      cat > kill_file_server.sh <<'EOF'
      #!/usr/bin/env sh
      # 避免用 -f 导致误杀，或者至少要更精准地匹配
      pkill -f 'file_server -auth' || echo "No process found"
      EOF

    # 2) 上传脚本到服务器
    - scp -i ~/.ssh/id_ed25519 kill_file_server.sh root@38.174.113.217:/root/kill_file_server.sh

    # 3) 在服务器上赋予脚本可执行权限并执行它
    - ssh -i ~/.ssh/id_ed25519 root@38.174.113.217 "chmod +x /root/kill_file_server.sh"
    - ssh -i ~/.ssh/id_ed25519 root@38.174.113.217 "/root/kill_file_server.sh"

    # 4) 上传新的 file_server 程序
    - scp -i ~/.ssh/id_ed25519 file_server root@38.174.113.217:/root/file_server/file_server

    # 5) 启动新进程
    - |
      ssh -i ~/.ssh/id_ed25519 root@38.174.113.217 << 'EOF'
        cd /root/file_server
        nohup ./file_server -auth :1132:1132 -http 80 -https 443 \
               -ssl-key ../tls/cert.key -ssl-cert ../tls/cert.pem &
        exit
      EOF

  only:
    - master
